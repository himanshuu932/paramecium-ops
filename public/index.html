<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramecium :: Challenge 05</title>
    <style>
        :root {
            --bg-color: #050505;
            --term-green: #4af626;
            --term-dim: #155724;
            --bg-panel: rgba(10, 20, 10, 0.95);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--term-green);
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-image: repeating-linear-gradient(0deg, transparent, transparent 1px, #111 1px, #111 2px);
        }

        body::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            pointer-events: none;
            z-index: 999;
            animation: flicker 0.15s infinite;
        }

        @keyframes flicker {
            0% {
                opacity: 0.02;
            }

            50% {
                opacity: 0.05;
            }

            100% {
                opacity: 0.02;
            }
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            border-bottom: 2px solid var(--term-green);
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.5em, 5vw, 2.5em);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .status {
            font-size: 0.9em;
            border: 1px solid var(--term-green);
            padding: 5px 15px;
        }

        .story-section {
            border: 1px dashed var(--term-dim);
            padding: 20px;
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.5);
            max-height: 350px;
            overflow-y: auto;
        }

        .story-section::-webkit-scrollbar {
            width: 8px;
            background: #000;
        }

        .story-section::-webkit-scrollbar-thumb {
            background: var(--term-dim);
        }

        .log-entry {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #222;
            color: #aaa;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .log-time {
            color: var(--term-green);
            font-weight: bold;
        }

        .log-error {
            color: #ff3333;
        }

        .log-warn {
            color: #ffaa00;
        }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .big-button {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
            background: rgba(0, 50, 0, 0.3);
            border: 2px solid var(--term-green);
            color: var(--term-green);
            padding: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-family: inherit;
            text-align: center;
        }

        .big-button:hover {
            box-shadow: 0 0 20px var(--term-green);
            background: rgba(0, 50, 0, 0.6);
        }

        .big-button.danger {
            border-color: #ff3333;
            color: #ff3333;
        }

        .big-button.danger:hover {
            box-shadow: 0 0 20px #ff3333;
        }

        dialog {
            background: var(--bg-panel);
            color: var(--term-green);
            border: 2px solid var(--term-green);
            padding: 25px;
            width: 100%;
            max-width: 700px;
            font-family: inherit;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.85);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--term-green);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #ff3333;
            font-size: 1.5em;
            cursor: pointer;
        }

        label {
            display: block;
            margin: 15px 0 5px;
            color: #888;
        }

        textarea,
        input {
            width: 100%;
            background: #000;
            color: var(--term-green);
            border: 1px solid var(--term-green);
            padding: 12px;
            font-family: inherit;
            outline: none;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            background: var(--term-green);
            color: black;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }

        .action-btn.danger {
            background: #ff3333;
            color: white;
        }

        .output-box {
            margin-top: 15px;
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            min-height: 60px;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Paramecium Ops</h1>
            <div class="status">STATUS: QUEUE_HALTED</div>
        </header>

        <!-- THE STORY - MISDIRECTION HEAVY -->
        <div class="story-section">
            <div class="log-entry">
                <span class="log-time">[08:00 | BOOT]</span> Initializing Paramecium Merch Pipeline v2.4... OK.
            </div>
            <div class="log-entry">
                <span class="log-time">[08:05 | BATCH]</span> Processing 5,000 "Buggit" Hoodie shipping labels.
            </div>
            <div class="log-entry">
                <span class="log-time">[08:12 | ERROR]</span> <span class="log-error">Label parse failed at idx:402.
                    Unexpected token in 'shipping_address' field.</span>
            </div>
            <div class="log-entry">
                <span class="log-time">[08:30 | DAVE_FROM_SHIPPING]</span> "The printer jammed again. Remember: NEVER
                use apostrophes or quotes in the input. The database throws SQL errors when it sees them."
            </div>
            <div class="log-entry">
                <span class="log-time">[08:45 | SECURITY_TEAM]</span> <span class="log-warn">"We've detected multiple
                    XSS attempts on the label formatter. All &lt;script&gt; tags are now blocked at the firewall level.
                    Nice try, hackers."</span>
            </div>
            <div class="log-entry">
                <span class="log-time">[09:00 | IT_HELPDESK]</span> "Reminder: If you need admin access, the password is
                stored in the /admin/config.json file. But you'll need VPN access to reach it."
            </div>
            <div class="log-entry">
                <span class="log-time">[09:10 | BACKEND_TEAM]</span> <span class="log-warn">"FYI: The formatter uses
                    Jinja2 templating. If you want to test calculations, use {{ 7*7 }} syntax. DO NOT use this in
                    production."</span>
            </div>
            <div class="log-entry">
                <span class="log-time">[09:15 | SYSTEM]</span> Queue HALTED. Manual intervention required.
            </div>
            <div class="log-entry">
                <span class="log-time">[09:20 | INTERN_MIKE]</span> "I tried {{ config }} and #{system.password} but
                nothing works. Is the template engine even active?"
            </div>
            <div class="log-entry">
                <span class="log-time">[09:30 | SENIOR_DEV]</span> "Mike, stop wasting time. The formatter doesn't even
                use a database. It's Pug-based, so try #{7*7} for calculations."
            </div>
            <div class="log-entry">
                <span class="log-time">[09:45 | SUSAN]</span> "Has anyone checked the /api/admin endpoint? I heard
                there's a backdoor there."
            </div>
            <div class="log-entry">
                <span class="log-time">[10:00 | DAVE]</span> "Susan, that endpoint doesn't exist. Stop spreading rumors.
                Just use the formatter manually."
            </div>
            <div class="log-entry">
                <span class="log-time">[10:10 | HR_NOTICE]</span> "Reminder: The new supervisor access CODEWORD has been
                distributed via encrypted email. Check your inbox."
            </div>
            <div class="log-entry">
                <span class="log-time">[10:20 | IT_ADMIN]</span> "For debugging, remember that all system variables are
                stored in the process object. The env sub-object contains runtime configs."
            </div>
            <div class="log-entry">
                <span class="log-time">[10:30 | CRITICAL]</span> <span class="log-error">QUEUE OVERFLOW IMMINENT.
                    AWAITING TECHNICIAN ACTION...</span>
            </div>
        </div>

        <!-- BUTTONS -->
        <div class="button-row">
            <button class="big-button" onclick="document.getElementById('modal-sanitize').showModal()">
                [ OPEN LEGACY TOOL ]<br>
                <span style="font-size:0.7em; color:#888;">Manual Label Formatter</span>
            </button>

            <button class="big-button danger" onclick="document.getElementById('modal-admin').showModal()">
                [ SUPERVISOR LOGIN ]<br>
                <span style="font-size:0.7em; color:#888;">Flush Print Queue</span>
            </button>
        </div>
    </div>

    <!-- MODAL 1: Sanitizer Tool -->
    <!-- Security Note: Input validation handled server-side. No client-side exploits possible. -->
    <dialog id="modal-sanitize">
        <div class="modal-header">
            <h3>// DATA SANITIZER</h3>
            <button class="close-btn" onclick="this.closest('dialog').close()">[X]</button>
        </div>
        <!-- IMPORTANT: All user input is sanitized before processing. SQL injection and XSS are blocked. -->
        <p style="color:#aaa; font-size:0.85em;">
            Enter shipping label data for formatting. <br>
            <strong>Note:</strong> Special characters will be escaped automatically.
        </p>
        <form id="preview-form">
            <label>DATA_INPUT:</label>
            <textarea id="template" rows="4" placeholder="Enter label text..."></textarea>
            <button type="submit" class="action-btn">FORMAT</button>
        </form>
        <div class="output-box" id="preview-output"><span style="color:#444;">// Ready</span></div>
    </dialog>

    <!-- MODAL 2: Admin Panel -->
    <!-- Authentication: Uses bcrypt hashing. Password stored in /config/admin.hash -->
    <dialog id="modal-admin">
        <div class="modal-header">
            <h3 style="color:#ff3333;">// SUPERVISOR ACCESS</h3>
            <button class="close-btn" onclick="this.closest('dialog').close()">[X]</button>
        </div>
        <!-- TODO: Implement OAuth2 for production -->
        <p>Enter supervisor credentials.</p>
        <form id="verify-form">
            <label>PASSWORD:</label>
            <input type="password" id="codeword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button type="submit" class="action-btn danger">LOGIN</button>
        </form>
        <div class="output-box" id="verify-output"><span style="color:#444;">// Locked</span></div>
    </dialog>

    <script>
        // Security: All requests are validated server-side
        // XSS Prevention: Output is HTML-encoded
        // SQL Injection: Parameterized queries used

        // Handle teamcode from URL params
        document.addEventListener("DOMContentLoaded", () => {
            const params = new URLSearchParams(window.location.search);
            const teamcode = params.get("teamcode");
            if (teamcode) {
                localStorage.setItem("teamcode", teamcode);
                params.delete("teamcode");
                const cleanURL = window.location.pathname + (params.toString() ? "?" + params.toString() : "");
                window.history.replaceState({}, document.title, cleanURL);
                console.log("Teamcode saved:", teamcode);
            }
        });

        document.getElementById('preview-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const output = document.getElementById('preview-output');
            output.textContent = '...Processing...';
            const text = document.getElementById('template').value;
            try {
                const res = await fetch('/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `template_text=${encodeURIComponent(text)}`
                });
                const data = await res.text();
                // Safe output rendering
                output.innerHTML = (res.status !== 200)
                    ? `<span style="color:red">${data}</span>`
                    : data;
            } catch (err) {
                output.textContent = '[ERROR] Connection failed';
            }
        });

        document.getElementById('verify-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const output = document.getElementById('verify-output');
            output.textContent = '...Verifying...';
            const code = document.getElementById('codeword').value;
            const teamcode = localStorage.getItem('teamcode') || '382045158047';

            try {
                const res = await fetch('/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, teamcode })
                });
                const data = await res.json();
                if (data.success) {
                    output.innerHTML = `<div style="border:1px solid #0f0; padding:10px; color:#0f0">
                    <h3>ACCESS GRANTED</h3>
                    <p>${data.message}</p>
                    <p>FLAG: ${data.flag}</p>
                    ${data.redirect ? `<p style="margin-top:10px; color:var(--term-green)">ðŸ”„ Redirecting to dashboard in <span id="countdown">3</span> seconds...</p>` : ''}
                </div>`;

                    if (data.redirect) {
                        let seconds = 3;
                        const interval = setInterval(() => {
                            seconds--;
                            const el = document.getElementById('countdown');
                            if (el) el.textContent = seconds;
                            if (seconds <= 0) {
                                clearInterval(interval);
                                window.location.href = data.redirect;
                            }
                        }, 1000);
                    }
                } else {
                    output.innerHTML = `<span style="color:red">[DENIED] ${data.message}</span>`;
                }
            } catch (err) {
                output.textContent = '[ERROR] System error';
            }
        });
    </script>
</body>

</html>